---
import Layout from '../layouts/Layout.astro';
---

<Layout title="User Messages">
  <main>
    <h1>User Messages</h1>
    <div id="messages-container">
      <div id="messages"></div>
    </div>
    <!-- Der "Zurück zur Seite" Button als Pfeil -->
    <button id="back-button">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
        <path d="M14 7l-5 5 5 5V7z"/>
      </svg>
      Zurück
    </button>
  </main>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    let messages = JSON.parse(localStorage.getItem('messages')) || [];
    const messagesContainer = document.getElementById('messages');
    const messagesContainerWrapper = document.getElementById('messages-container');
    const backButton = document.getElementById('back-button');

    function renderMessages() {
      if (!messagesContainer) return; // Sicherheitsüberprüfung

      messagesContainer.innerHTML = '';

      messages.forEach((msg, index) => {
        const messageEl = document.createElement('div');
        messageEl.classList.add('message');
        messageEl.innerHTML = `
          <p><strong>${msg.title}</strong></p>
          <p><strong>${msg.username || 'Anonym'}:</strong> ${msg.message}</p>
          <div class="replies">
            ${msg.replies ? msg.replies.map(reply => `<div class="reply"><strong>${reply.username}:</strong> ${reply.message}</div>`).join('') : ''}
          </div>
          <button class="delete-button" data-index="${index}">Löschen</button>
        `;

        messagesContainer.appendChild(messageEl);
      });

      // Scrollen zum neuesten Eintrag
      messagesContainerWrapper.scrollTop = messagesContainerWrapper.scrollHeight;
    }

    messagesContainer?.addEventListener('click', function(event) {
      const target = event.target as HTMLElement;

      if (target.classList.contains('delete-button')) {
        const index = target.getAttribute('data-index');
        if (index === null) return;

        if (confirm('Sind Sie sicher, dass Sie diese Nachricht löschen möchten?')) {
          messages.splice(parseInt(index), 1); // Nachricht aus dem Array entfernen
          localStorage.setItem('messages', JSON.stringify(messages)); // Array speichern
          renderMessages(); // Seite aktualisieren
          alert('Nachricht wurde gelöscht!');
        }
      }
    });

    // Zurück-Button Logik
    backButton.addEventListener('click', () => {
      window.history.back();  // Gehe zur vorherigen Seite
    });

    renderMessages();
  });
</script>

<style>
  main {
    margin: auto;
    padding: 1rem;
    width: 500px;
    max-width: calc(100% - 2rem);
    color: rgb(11 11 11);
    font-size: 10px;
    line-height: 2;
    position: relative;  /* Wichtig für die Positionierung des "Zurück"-Buttons */
  }

  #messages-container {
    border: 1px solid #ddd; /* Rahmen für den Container */
    border-radius: 8px; /* Abgerundete Ecken */
    padding: 0.5rem;
    background: #f9f9f9; /* Hintergrundfarbe für Container */
    max-height: 500px; /* Maximale Höhe für Container */
    overflow-y: auto; /* Ermöglicht vertikales Scrollen */
  }

  .message {
    margin-bottom: 1rem;
    padding: 1rem;
    border-radius: 4px;
    background: #333;
  }

  .replies {
    margin-top: 1rem;
    padding-left: 1rem;
    border-left: 2px solid #ccc;
  }

  .reply {
    margin-top: 0.5rem;
    padding: 0.5rem;
    border-radius: 4px;
    background: #444;
  }

  .delete-button {
    margin-top: 1rem;
    padding: 0.75rem 1.5rem;
    background: #e9dad8;
    color: #070606;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  .delete-button:hover {
    background: #f1e5e3;
  }

  /* Stil für den "Zurück" Button mit Pfeil */
  #back-button {
    position: absolute;  /* Positionierung innerhalb von "main" */
    bottom: 1rem;        /* Abstand vom unteren Rand */
    right: 1rem;         /* Abstand vom rechten Rand */
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: linear-gradient(to right, rgb(231 238 231), rgb(13 6 6));
    color: hsl(0deg 7% 3%);
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgb(0 0 0 / 10%);
    cursor: pointer;
    transition: background 0.3s ease, transform 0.3s ease;
  }

  #back-button:hover {
    background: rgb(145 190 130);
    transform: translateY(-2px);
  }

  /* Stil für das Pfeil-SVG */
  #back-button svg {
    fill: currentcolor;  /* Erbt die Textfarbe des Buttons */
  }
</style>
